<div id="header" align="center">
  <h1>ktradesystem</h1>
</div>

### Описание

ktradesystem - это приложение для тестирования торговых моделей.

Приложение отличается возможностью проводить форвардное тестирование для оценки эффективности и стабильности модели при реальной торговле, а также достоверными результатами: заявки исполняются только в случае гарантированного исполнения, а сделки совершаются по гарантированной цене.

----

### Технологии

- C#
- WPF
- SQLite

----

### Статус и дальнейшие планы

Проект полностью выполняет свою задачу.

В дальнейшем планирую добавить тестирование нейронных сетей, а так же оптимизировать некоторые решения.

----

### Функциональные возможности на примере

Приложение использует понятие "Источник данных" - это торговый инструмент с набором свойств, и путями к файлам с данными на диске. Можно использовать акции, фьючерсы, валюту, криптовалюту.
Если используется срочный фьючерсный контракт, то можно указать несколько файлов для источника данных, где каждый файл - данные по конкретному контракту. Во время тестирования, при переходе на следующий файл, позиция автоматически закроется по предыдущему файлу.

![01](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/4262b0e9-18d2-42ff-a89d-c351a5f85b62)

Страница "Тестирование торговых моделей" содержит три колонки: индикаторы, алгоритмы, и параметры тестирования.

![02](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/692079bc-9371-48d0-a25d-90a0c9c0cd12)


Индикаторы - вещественные значения, которые получаются в результате определенной обработки данных с графика. Приложение предоставляет определенный программный интерфейс для обращения к данным графика (свечкам) из скрипта индикатора.

Например индикатор максмального значения за определенный период:

![03](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/944b3c41-fbc9-4ae4-81ec-d9889500ce7e)

Данные графика находятся в массиве Candles, по 0-му индексу находится последняя свечка, по 10-индексу находится свечка, которая раньше последней на 10 свечек.
Для обращения к данным свечки используются свойства: O (цена открытия), H (цена максимума), L (цена минимума), C (цена закрытия), V (объем), DateTime (дата и время свечки). Например, Candles[0].C - цена закрытия последней свечки.
Значение индикатора находится в переменной Indicator, которой и нужно присвоить вычисленное значение.

В индикаторе используются специальные переменные - "Оптимизируемые параметры", впоследствии на их место будет подставлено определенное значение.
Оптимизируемые параметры имеют тип числа, либо целый либо дробный.

В данном случае есть параметр - period, который отражает количество свечек, за которое нужно определять максимум цены. Доступ к этому значению имеется через специальную переменную Parameter_period.

Скрипт представляет собой текст программы на языке C#.

В данном индикаторе виден простой цикл, написанный на языке C#, ищущий максимум среди свечек за определенный период.


Алгоритмы - это правила торговой модели. Результатом выполнения скрипта алгоритма является список с заявками, которые должны быть выставлены.

![04](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/036c9087-886a-4e72-8397-1fc0281c9b60)

Алгоритмы используют специальные переменные - "Оптимизируемые параметры алгоритма", их можно подставлять в "Оптимизируемые параметры" индикаторов, а так же можно обращаться к ним из скрипта алгоритма.

Оптимизируемые параметры алгоритма имеют тип числа, либо целый либо дробный. Подставить в параметр индикатора можно только параметр алгоритма соответствующего типа числа.
Так же оптимизируемые параметры алгоритма имеют минимальное значение, максимальное значение и шаг сканирования.

![05](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/f1153d4b-23ef-4482-88dd-bb269a2f5b5e)

Для оптимизируемого параметра алгоритма будут созданы значения: от минимального до максимального с шагом сканирования. Для каждого значения будет создан тестовый прогон. Тестовый прогон - одиночный тест.
Если оптимизируемых параметров алгоритма несколько, будут созданы тестовые прогоны для всех комбинаций их значений.

В алгоритм можно добавить индикатор, при этом нужно будет добавить ему "Окончание названия", которое позволит идентифицировать его в случае добавления еще одного такого индикатора.

![06](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/1124bad1-0728-4c19-810a-3996ea6b157f)

Далее нужно выбрать оптимизируемый параметр алгоритма для параметров индикатора, в списке доступны только параметры того же типа:

![07](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/a16da2ed-437c-4429-a366-68665225ecd4)

В алгоритме используется понятие "Макет источника данных" - это обозначение источника данных, на место которого будет подставлен источник данных, выбранный в настройках тестирования.
Макетов можно добавить несколько, таким образом можно создать торговую модель, использующую несколько торговых инструментов.

Сценарий алгоритма - скрипт, написанный на языке C#, суть которого выставление заявок.

![08](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/6bb63350-da88-422a-8e0d-0aa03cffb72b)

Множество кнопок над текстовым полем скрипта позволяют подставить на текущее положение курсора в тексте, код соответствующего значения.
В данном случае неактивны кнопки "Источники данных", чтобы они стали активны нужно выбрать макет источника данных в списке макетов источников данных. При нажатии на кнопку, в текст сценария будет подставлен код соответствующего значения.

Пример выставления заявки: при нажатии на кнопку: рыночная продать "Order_MarketSell" вставляется код:

![09](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/11c7e678-d48c-44ea-ae0d-80313e756b09)

на место текста "источникДанных" нужно вставить код по кнопке "Источник данных", на место "цена" можно вставить цену последней свечки по кнопке "Данные графика", и приписать .C, на место "количество" можно поставить 1,
однако в большинстве случаев количество будет изменено на минимальное количество лотов для данного источника данных.
Только для форвардного тестирования с торговлей депозитом можно устанавливать свое значение количества лотов.

![10](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/87287300-fd27-4c45-8238-9280692ee428)

Данный код выставит рыночную заявку на продажу. Это то же самое что и продать по текущей цене.

На изображении сценария алгоритма выше можно видеть скрипт алгоритма Trend. В нем используются индикатор с названием PriceChangePercentMaPtOffset. Суть индикатора следующая: для свечки можно вычислить типичную цену: (Candles[i_c].H+Candles[i_c].L+Candles[i_c].C)/3, если взять это значение для последних трёх свечек (период скользящей средней), и поделить на три, получится скользящая средняя типичной цены. В индикаторе вычисляются значения скользящей средней (период указывается в параметре maPtPeriod) типичной цены для последней свечки, и для свечки которая раньше последней на значение параметра period (назовем эту свечку предыдущей). Далее из значения скользящей средней типичной цены последеней свечки вычитается значение скользящей средней типичной цены предыдущей свечки. Данная разность отражает изменение цены за определенный период. Затем эта разность делится на значение скользящей средней типичной цены предыдущей свечки, и умножается на 100, получается изменение цены в % за период.

Суть торговой модели - если величина изменения цены достигла допустимого значения (значение параметра requiredTrendPercent), значит это тренд, и открываем позицию. Если величина изменения цены упала ниже допустимого значения, значит тренд закончился, закрываем позицию. Условие прекращения тренда ниже условия определения тренда на величину параметра Parameter_requiredTrendEnd, это сделано чтобы позиция не закрывалась сразу в случае колебания цены в сторону уменьшения тренда.

В первой строчке скрипта написано условие: if ( Datasource_template.CountBuy + Datasource_template.CountSell == 0 ), которое истинно когда мы вне позиции, в этом случаем мы проверяем, абсолютное значение разности между предыдущей и последней свечкой, достаточное для определения тренда: if ( Math.Abs(Datasource_template_Indicator_PriceChangePercentMaPtOffset_1) >= Parameter_requiredTrendPercent ), если да, то отмечаем что нужно открыть позицию. Если значение тренда положительное: if ( Datasource_template_Indicator_PriceChangePercentMaPtOffset_1 > 0 ), покупаем, иначе продаем. Похожим образом проверяется уловие на прекращение тренда.

Так же добавлено еще два индикатора MaPtOffset (скользящая средняя типичной цены с отступом от последней свечки), для одного отступ указан в 0, для другого в значение параметра period. Они добавлены для наглядности определения значения тренда.


Параметры тестирования.

![11](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/afb2c4ca-aa31-41ea-8aab-856b5130acb8)

Чтобы провести тестирование определенного алгоритма, необходимо выбрать его в списке алгоритмов, его название отобразится в параметрах тестирования.

Источники данных для тестирования - позволяют выбрать источники данных, которые будут подставлены в макеты источников данных алгоритма. В данном случае выбрано две криптовалюты: BTC и ETH.

Топ-модель - это тестовый прогон с наибольшим значением критерия оценки топ-модели.
Далее после определения топ-модели, можно провести форвардное тестирование, то есть тестирование топ-модели на последующих, за периодом оптимизации, данных.

Учитывать соседние результаты при поиске топ-модели: когда выбрано, выбор топ-модели проходит в два этапа: первый этап - выбор самой лучшей, по критерию оценки, группы тестовых прогонов, размер группы задается в соответствующем поле,
второй этап - выбор самого лучшего, по критерию оценки, тестового прогона внутри лучшей группы. Смысл этого в том чтобы не выбрать пик прибыли, являющийся аномалией, а не закономерностью.

После выбора всех необходимых настроек можно запускать тестирование.


Результаты тестирования торговых моделей.

![12](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/6b60df3a-4b18-4004-b40d-1aeda8453bd3)

Результаты тестирования хранятся в истории, можно просматривать результаты предыдущих тестирований.

На странице Результаты тестирования торговых моделей есть две вкладки: Тестовая связка и Тестовый прогон.

На первой вкладке отображается трехмерный график для выбранных: источника данных, и выбранной тестовой связки (оптимизационные тесты в рамках одного периода). Так же есть две таблицы, отображающие информацию по форвардным и оптимизационным тестам.

Трехмерный график отображает значения критериев оценки для каждой комбинации оптимизируемых параметров. Критерии оценки можно выбирать. График можно вращать, на заднем плане шкалы значений, в нижней части графика отображаются оси со значениями оптимизационных параметров алгоритма, на пересечении значений осей распологается тестовый прогон с соответствующими значениями параметров.

![13](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/a2f108e3-c29b-43fd-bf99-78cb32b75f95)

Вкладка Тестовый прогон - содержит всю информацию о тестовом прогоне. На ней расположен график котировок, значения критериев оценки, список с заявками, список с сделками и график прибыли и убытков.

![14](https://github.com/xristian14/ktradesystem_v1.1/assets/61497170/3f65ca22-8186-49da-a5d1-1f4f5eab9f9f)

На свечках можно разглядеть индикатор скользящей средней типичной цены для последней свечки. Линия, не совпадающая со свечками - это значение скользящей средней типичной цены для свечки, которая раньше последней на 144 свечки.
В нижней части графика находится значение индикатора PriceChangePercentMaPtOffset. Можно видеть что когда предыдущее значение скользящей средней типичной цены выше текущего, значение тренда положительное, и пропорционально их разности, соответственно когда текущая цены ниже предыдущей, значение тренда отрицательное.





